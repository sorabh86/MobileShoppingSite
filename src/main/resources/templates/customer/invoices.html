<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments::page_head('Customer | Orders')" />
<body>
<div class="d-flex flex-column" style="min-height:100vh">
	<div th:replace="fragments::top_navigation('orders')" />
	<div th:replace="fragments::main_navigation('orders')" />
	<div class="ml-5 mr-5 mt-4 d-flex flex-grow-1">
		<div class="row flex-grow-1">
			<div th:replace="fragments::customer_menu('invoices')"></div>
			<div class="col pl-4">
				<h2>Your Invoices</h2>
				<div class="alert alert-success" th:if="${message}">[[${message}]]</div>
				<table class="table table-striped table-bordered">
					<thead class="thead-dark">
						<tr>
							<th>Id</th>
							<th>Order Date</th>
							<th>Order Details</th>
							<th>Status</th>
							<th>Address</th>
							<th>Options</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="order: ${orders}" th:class="${order.isVisited?'bg-visted order order-'+order.id:'order order-'+order.id}" >
							<td>[[${order.id}]]</td>
							<td class="order-date">
								<div class="date-time">[[${#dates.format(order.created_date,"hh:mm a")}]]</div>
								<div class="date-date">[[${#dates.format(order.created_date,"dd MMM, yyyy")}]]</div>
								<small class="date-delivery badge badge-success">Expected: <span class="days">[[${order.expected_delivery_days==null?0:order.expected_delivery_days}]]</span> Days</small>
							</td>
							<td class="order-items" th:with="orderItems = ${order.orderItems}">
								<small>
									<p class="m-0 item" style="position:relative" th:each="orderItem, status : ${orderItems}"> 
										<span>[[${status.count}]].</span>
										<span>[[${orderItem.phone.title}]]</span>
										<span style="float:right" class="text-secondary">
											... x<span class="item-quantity">[[${orderItem.quantity}]]</span>
											<span class="item-amount text-danger">[[${orderItem.amount}]]</span>
										</span>
									</p>
									<hr class="m-1" />
									<strong class="total-amount text-danger text-right d-block">[[${order.grandTotal}]]</strong>
								</small>
							</td>
							<td class="text-center">
								<div class="payment-method">[[${order.paymentMethod=='OP'?'Online Payment':'Cash on Delivery'}]]</div>
								<span th:if="${order.status.toString()=='REQUESTED'}" class="status badge badge-primary">[[${order.status}]]</span>
								<span th:if="${order.status.toString()=='APPROVED'}" class="status badge badge-warning">[[${order.status}]]</span>
								<span th:if="${order.status.toString()=='SHIPPED'}" class="status badge badge-info">[[${order.status}]]</span>
								<span th:if="${order.status.toString()=='REJECTED'}" class="status badge badge-danger">[[${order.status}]]</span>
								<span th:if="${order.status.toString()=='DELIVERED'}" class="status badge badge-success">[[${order.status}]]
									<span th:if="${order.delivery_date}" class="delivery-date">
									<br />[[${#dates.format(order.delivery_date, "dd MMM yyyy")}]]</span>
								</span>
								<span th:if="${order.status.toString()=='CANCELLED'}" class="status badge badge-danger">[[${order.status}]]</span>
								<div class="payment-status">
									<span class="badge badge-secondary">[[${
										(order.paymentMethod=='COD' && order.status.toString()=='DELIVERED')?
										'PAID':(
											(order.paymentMethod=='OP' && order.payments!=null && order.payments.size()>0)?
											(order.payments.get(0).status):
											'NOT PAID'
										)
									}]]</span>
								</div>
							</td>
							<td class="address" th:with="adr = ${order.address}" th:utext="${adr.full_name+'<br>'+adr.address_line_1+
								', '+adr.address_line_2+'<br>'+adr.city+' '+adr.state+', '+adr.country+'-'+adr.zip}"></td>
							<td>
								<a class="invoice-btn text-primary" href="#">Download Invoice</a>
							</td>
						</tr>
					</tbody>
				</table>

			</div>
		</div>
	</div>
	<div class="mt-auto">
		<footer th:replace="fragments::footer()" />
	</div>
</div>

<div id="orderinvoicewindow" class="modal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header bg-dark text-light">
				<h3>Order Invoice</h3>
				<button type="button" class="close text-light" data-dismiss="modal"
					aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div id="order-details">
					<h2>
						<img th:src="@{/images/logo-sm.png}"/> MOBILE SHOPPING SITE
					</h2>
					<h4 class="mt-3 d-flex">Order Receipt Details
						<span class="invoice-pay-status badge badge-success ml-auto">PAID</span>
					</h4>
					<table class="table">
						<tr>
							<td><strong>Receipt Id: </strong></td>
							<td>txn_<span class="invoice-id">3</span></td>
						</tr>
						<tr>
							<td><strong>Order Date: </strong></td>
							<td class="invoice-date d-flex justify-content-between">dd MMM yyyy, HH:mm aa</td>
						</tr>
						<tr>
							<td><strong>Order Status: </strong></td>
							<td><span class="invoice-status">PAID</span></td>
						</tr>
						<tr>
							<td><strong>Payment Method: </strong></td>
							<td><span class="invoice-pay-method">CASH ON Delivery</span></td>
						</tr>
						<tr>
							<td><strong>Customer Address: </strong></td>
							<td><span class="invoice-address">CASH ON Delivery</span></td>
						</tr>
					</table>
					<hr />
					<p class="invoice-items h3">
						<strong>1: Phone Name </strong> 
						<span>x1 ---- </span> <span class="float-left">Rs. 0</span>
					</p>
				</div>
			</div>
			<div class="modal-footer">
				<a id="print-btn" href="#" class="btn btn-primary">Print</a>
				<button type="button" data-dismiss="modal" class="btn btn-secondary">Cancel</button>
			</div>
		</div>
	</div>
</div>

<script type="text/JavaScript" th:src="@{/js/jQuery.print.js}"></script>
<script>

//Show order details
var $orderdetailwindow = $("#orderdetailwindow"),
	$ordercancelwindow = $("#ordercancelwindow"),
	$orderinvoicewindow = $("#orderinvoicewindow");

window.so = window.so || {};

function setSoObj($parent) {
	so.address = $parent.find(".address").html();
	so.status = $parent.find(".status").html();
	so.paymentMethod = $parent.find(".payment-method").html();
	so.paymentStatus = $parent.find(".payment-status").html();
	so.orderItems = $parent.find(".order-items").html();
	so.orderDate = $parent.find(".order-date").html();
}

// ORDER INVOICE GENERATION CODE
$(".invoice-btn").on("click", function() {
	setSoObj($(this).parent().parent());
	var id = $orderdetailwindow.data("id");
	
	var $paymentStatus = $(so.paymentStatus);
	var payStatus = $paymentStatus.html();
	var $invoicePayStatus = $orderinvoicewindow.find(".invoice-pay-status");
	console.log(payStatus);
	if(payStatus == 'PAID') {
		$invoicePayStatus.removeClass("badge-danger");
		$invoicePayStatus.addClass("badge-success");
	} else {
		$invoicePayStatus.addClass("badge-danger");
		$invoicePayStatus.removeClass("badge-success");
	}
	
	$orderinvoicewindow.find(".invoice-id").html(id);
	$invoicePayStatus.html(payStatus);
	$orderinvoicewindow.find(".invoice-status").html(so.status.replace("<br>", " on "));
	$orderinvoicewindow.find(".invoice-address").html(so.address);
	$orderinvoicewindow.find(".invoice-pay-method").html(so.paymentMethod);
	$orderinvoicewindow.find(".invoice-items").html(so.orderItems);
	$orderinvoicewindow.find(".invoice-date").html(so.orderDate);
	$orderinvoicewindow.modal();
});

$("#print-btn").on("click", function(){
	$("#order-details").print();
	return false;
});


</script>
</body>
</html>